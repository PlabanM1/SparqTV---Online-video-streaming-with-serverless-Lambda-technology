<!DOCTYPE html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<head>
  <title>Login Page</title>
  
</head>

<body>
<script>
var name ="";
var email="";
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1197867396915792',
      xfbml      : true,
      version    : 'v2.8'
    });
    FB.AppEvents.logPageView();
    FB.getLoginStatus(function (response){
      if(response.status === 'connected'){
        document.getElementById('status').innerHTML = "We re connected";
        FB.api('/me','GET',{fields: 'first_name,last_name,name,email'},function(response){
        document.getElementById ('Information').innerHTML=response.name+" "+response.email;
        eid = response.email;
        name=response.name;
        email=response.email;
        checkExist(eid);
        //getFriends();
        
      })}
      else if(response.status === 'not_authorized'){
        document.getElementById('status').innerHTML = "Not logged in";
      }
      else {
        document.getElementById('status').innerHTML = "Not connected to facebook";
      }
    })
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

    function login(){
      FB.login(function (response){
      if(response.status === 'connected'){
        document.getElementById('status').innerHTML = "We re connected";
      }
      else if(response.status === 'not_authorized'){
        document.getElementById('status').innerHTML = "Not logged in";
      }
      else {
        document.getElementById('status').innerHTML = "Not connected to facebook";
      }
      });
    }
    function getInfo(){
      FB.api('/me','GET',{fields: 'first_name,last_name,name,id'},function(response){
        document.getElementById ('Information').innerHTML=response.name;
      })
    }
    /*function getFriends(){
      console.log("start")
      FB.api('/me/friends', function(response) {
        if(response && !response.error){
        console.log(response.data)
        if(response.data) {
            $.each(response.data,function(index,friend) {
                alert(friend.name + ' has id:' + friend.id);
            });
        } else {
            alert("Error!");
        }
    }
      else{
        alert("Error!");
      }
    });
    }*/
    function getFriends(){
      console.log("start")
      var friends=[];
      FB.api('/me/friends', function(response) {
        if(response && !response.error){
        console.log(response.data)
        //friends=response.data 
        if(response.data) {
            $.each(response.data,function(index,friend) {
                //alert(friend.name + ' has id:' + friend.id);
                friend1={
                  "name" : friend.name,
                  "UUID" : friend.id
                };
                friends.push(friend1);
                //console.log("check",JSON.stringify(friends));
            });

              
    $.ajax({
    url: 'https://prfq8d4onb.execute-api.us-west-2.amazonaws.com/prod/Person',
    type: 'POST',
    data: JSON.stringify({
      "operation":"create",
      "type":"person",
      "UUID":email,
      "name":name,
      "friends": friends          
    }),
    dataType: 'json',
    contentType: 'application/json',
    processData: false,
    success: function( data, textStatus, jQxhr ){
      console.log(data);
      console.log(textStatus);
      console.log("Graph db succesful")
      //$('#response pre').html("success");
      //alert("Success");
    },
    error: function (xhr, ajaxOptions, thrownError) {

      //errtext=xhr.responseJSON.errorMessage;
      //$('#response pre').html(errtext);
      console.log("Graph db unsuccesful");
      //console.log(ajaxOptions);
      console.log(thrownError);
              //alert(thrownError);
            },
    crossDomain: true
          });


        } else {
            alert("Error!");
        }
    }
      else{
        alert("Error!");
      }
    });
      
    
    }
    function checkExist(eid){
      
    $.ajax({
    url: 'https://j3z4xwt1ch.execute-api.us-west-2.amazonaws.com/prod/customers/'+eid,
    type: 'GET',
    dataType: 'json',
    contentType: false,
    processData: false,
    success: function( data, textStatus, jQxhr ){
      console.log(data);
      console.log(textStatus);
      window.location.href="http://www.lambdacheck.com.s3-website-us-west-2.amazonaws.com/ContentPage.html";
    },
    error: function (xhr, ajaxOptions, thrownError) {
              //$('#response pre').html("error");
              errtext=String(xhr.responseJSON.errorMessage);
              var errcode=errtext.substring(1, 4);
              console.log(xhr);
              console.log(ajaxOptions);
              if(errcode=="404"){
                document.getElementById ('check1').innerHTML="No such user found";
                window.location.href="http://www.lambdacheck.com.s3-website-us-west-2.amazonaws.com/Fbform.html";

              }
              else
              {
                document.getElementById ('check1').innerHTML=errtext;
                //window.location.href="http://www.lambdacheck.com.s3-website-us-west-2.amazonaws.com/Fbform.html";

              }
              //alert(thrownError);
              //window.location.href="http://www.lambdacheck.com.s3-website-us-west-2.amazonaws.com/Fbform.html";
            }
          });
    }
</script>
<div id="status"></div>

<div id="Information"></div>
<div id="check1"></div>
</body>
</html>

